---
title: 'Towards an Off-Grid Fecal Sludge Treatment Unit: Demonstrating Energy Positive
  Thermal Treatment'
author: "T. Myers, L. Schoebitz, S. Woolley, J. Sanchez Ferragut, J. Thostenson, K. Jooss, J.Piascik,  B. Stoner, J. Hallowell"
date: 'last update: `r Sys.Date()`'
output:
  bookdown::word_document2: default
  bookdown::pdf_document2:
    fig_caption: yes
    includes:
      in_header: preamble-latex.tex
bibliography: [chp-article.bib, pkg-refs.bib]
editor_options:
  chunk_output_type: console
---

```{r, include=FALSE}

#### IMPORTANT: Exclude this chunk if output is not pdf_document2

# knitr::knit_hooks$set(plot = function(x, options)  {
#   knitr::hook_plot_tex(x, options)
# })
# 
```

```{r setup, include=FALSE}

## set chunks output ------------------

knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE, 
  echo = FALSE
)


```

```{r}

## load required libraries 

library(tidyverse)
library(networkD3)
library(scales)

```

```{r}

# Data from SQL query for GI7 and 2018-08-14. 
data <- read_csv(here::here("data/raw/database_GI7_2018-08-14.csv"))

# sensor component names data 
sensor_tidy <- read_csv(here::here("data/intermediate/sensor_component_names_GI7_tidy.csv"))

# fuel rate measurements on 2018-08-14
# measurements were taken manually. fuel was weighed at specific time intervals

fuel_rate_data <- tibble(
  fuel_lb = c(54, 58, 48, 54),
  time_min = c(48, 50, 40, 42),
) %>% 
  mutate(
    mass_flow_lb_hr = fuel_lb/time_min * 60,
    mass_flow_kg_hr = mass_flow_lb_hr * 0.45359237  ## conversion to kg
  ) %>% 
  write_csv(here::here("data/raw/fuel_rate_data.csv"))

# duratherm oil thermal properties

duratherm_oil <- read_csv(
  file = here::here("data/intermediate/duratherm_oil_properties_tidy.csv")
  )

# water properties

water_properties <- read_csv(
  file = here::here("data/intermediate/water_properties_tidy.csv")
  )

# water pipe data

pipe_assembly <- read_csv(
  file = here::here("data/raw/pipe_assembly_data.csv")) 

pipe_assembly_data <- pipe_assembly %>% 
  rename_all(.funs = snakecase::to_snake_case) %>% 
  select(component, r_pipe_k_k_w, r_insulation_k_k_w) %>% 
  write_csv(path = here::here("data/intermediate/pipe_assembly_data_small.csv"))

# jacket heat loss temperature measurements

jacket_heat_loss <- read_csv(
  file = here::here("data/raw/jacket_heat_loss_temperature_measurements.csv")
  )

```


```{r}

## data manipulation

data_tidy <- data %>% 
  left_join(sensor_tidy) %>% 
  filter(!is.na(component)) %>% 
  filter(
    component != "empty" # sensor CN9Rpm not used in setup
  ) %>% 
  select(date_time, status, component, value, unit) 


```

```{r}

## get summarised data for ambient temperature

ambient_temp <- data_tidy %>% 
  filter(str_detect(component, "ambient")) %>% 
  filter(status %in% c("Run-Dry", "Run-Wet", "RUN_OVERHEAT")) %>% 
  group_by(component, unit) %>% 
  summarise(
    mean_ambient_temp = mean(value),
    sd_ambient_temp = sd(value)
  )



```

# Abstract

**Background:** There is an unmet demand for community-scale fecal sludge treatment units (FSTUs) that serve communities of between 1,000 and 50,000 people and are able to operate in non-sewered and off-grid environments. An emerging industry standard for FSTUs  includes as a key criteria energy independence in steady-state. Theoretically, there is sufficient thermal energy available in fecal sludge to provide the electrical power needed to run the FSTU. However, such a system had never been implemented.   
**Methods:** Biomass Controls has previously demonstrated the thermal treatment of fecal sludge using the Biogenic Refinery, a thermal FSTU deployed in three sites in India. In this article we describe testing where a Biogenic Refinery was paired with a thermal fluid heat exchanger and organic Rankine cycle generator to generate electrical power.  
**Results and Conclusions:** This Biogenic Refinery Combined Heat and Power system generated sufficient electrical power to offset electrical parasitic loads. Additional steps are necessary to transition to a true off-grid FSTU.


# Introduction

Community scale fecal sludge treatment units (FSTUs) are an important technology in meeting the needs of the 2.5 billion people without adequate sanitation [@world2017progress; @roseCharacterizationFecesUrine2015b]. Many of these communities also lack access to consistent electricity [@ieaWorldBankSustainable2019]. To encourage the development of FSTUs that meet these needs, the International Standards Organization (ISO) is developing the ISO/PC318 standard for community scale resource oriented sanitation treatment systems [@iso/pc318ISOPC3182019]. Key criteria for compliance with this emerging standard include: (1) the inactivation of pathogens present in fecal sludge and (2) energy independence or off-grid operation. EPA Rule, 40 CFR Part 503, Standards for the Use or Disposal of Sewage Sludge, is a widely adopted standard regulating the inactivation of pathogens in biosolids and provides guidance on how the first key criteria may be met across different treatment techniques including thermal treatment [@usepaPlainEnglishGuide2018]. High pH processes, composting, irradiation, and aerobic digestion. To meet the second key criteria, the treatment processes must be energy neutral or energy positive and operate on faecal sludge only without supplemental energy from other sources.
 
Thermal treatment technologies are a promising approach that could meet both of these criteria. In contrast to other pathogen elimination strategies, high temperature thermal treatment offers rapid inactivation of pathogens in a small footprint, without requiring disinfecting chemicals. Further, thermal treatments including pyrolysis, gasification, and combustion can liberate stored energy present in the fecal sludge providing thermal energy useful for processing the fecal sludge and for conversion to electrical energy to run the process.

In the present work, the Biomass Controls Biogenic Refinery (BR), an existing thermal FSTU, was paired with a thermal fluid heat exchanger and organic Rankine cycle (ORC) generator to make a combined heat and power (CHP) unit. The BR is currently used as an FSTU in several communities in India fulfilling pathogen inactivation requirements given in 40 CFR Part 503. The objective of the present study is to demonstrate that there is sufficient electrical power produced by the BR CHP to offset the electrical power necessary to run the BR CHP.

To provide this demonstration, first, we describe the BR CHP system and its modules as well as the test protocol followed. Next, we present a thermal power balance based on measurements of the system during steady-state operation to demonstrate energy available in the thermochemical process. Last, we present measurements of electrical power generated by the ORC as well as the electrical power consumed by the BR CHP system, to calculate net power produced. The result of the study is a demonstration that the key requirements for the emerging standard for community scale FSTUs are achievable.

# Methods 

## Description of Biogenic Refinery

The BR CHP system consists of four connected modules: (1) the pyrolysis-combustion module responsible for pyrolysing the feedstock and liberating thermal energy from the feedstock as described in Section 2.1; (2) the oil working fluid heat exchanger module responsible for directing a portion of the available thermal energy towards the ORC module; (3) the ORC module responsible for converting thermal energy to electricity; and (4) the hydronic heat exchanger module responsible for extracting additional thermal energy for the purpose of drying incoming feedstock.

The BR system is a thermal FSTU capable of refining any biogenic matter into inert carbon with significant volume reduction, carbon sequestration in the form of biochar, and controlled emissions. The BR uses a pyrolysis-combustion process to inactive pathogens while producing thermal energy and biochar as outputs. The BR is capable of processing approximately 150 kg dry basis of feedstock per day (based on 8 hours of operation), consistent with the ISO/PC318 goal of serving small communities. This amounts to a >18 kg/hr (dry basis) average across a daily 8 hour process period. 

Thermal energy from the feedstock is released by the pyrolysis-combustion module and exits in hot exhaust gases. This thermal energy is extracted from the hot exhaust gases by a heat exchanger filled with a thermal working fluid, in our case oil. The thermal energy from the oil working fluid is transferred to the ORC module. The thermal energy remaining in the hot exhaust gases is transferred by the hydronic heat exchanger to further heat the water which is later used for drying.

## Description of ORC Electrical Generation

The ORC module uses the thermal energy from the BR to generate electricity. A schematic of the BR CHP system operation can be seen in Figure \@ref(fig:orc-drawing).

```{r orc-drawing, fig.cap="The Biogenic Refinery Combined Heat and Power system uses thermal energy produced through the thermal treatment of feedstocks to generate electrical power using an organic Rankine cycle generator."}

knitr::include_graphics(here::here("manuscript/images/CHP_ProcessFlowDiagram.jpg"))

```

The thermal energy is delivered from the BR to the ORC module using the oil working fluid. This working fluid is used to evaporate a different organic working fluid within the ORC. This evaporated fluid is used in conjunction with a scroll expander and run an electric generator. Following electrical generation, the working fluid is condensed using a water heat exchanger within the ORC, and the heated water is used for heating. The ORC used in the BR CHP system had a rated electrical generation capacity of 4 kWe with a nominal 8% generation efficiency. Because the ORC has only 8% efficiency in generating electricity, 92% of the original thermal energy remains available for heating applications following energy conversion. In the BR CHP, this energy is used to heat water which is then further heated by the BR hydronic heat exchanger module and ultimately used for the drying of incoming feedstock.

## Feedstock

FSTUs are intended to primarily treat fecal sludge. However, in a laboratory setting, a sufficient volume of fecal sludge for extended testing is difficult to acquire. Instead, a surrogate feedstock with a similar caloric value, or effective heat of combustion, was sought. The effective heat of combustion of dry feces varies substantially depending on location and source. A study by @goldFaecalSludgeSolid2017 found effective heats of combustion of 13.4 MJ/kg and 10.9 MJ/kg in Dakar, Senegal and Kampala, Uganda, respectively.  A study by @musprattFuelPotentialFaecal2014b found effective heats of combustion of 16.6 MJ/kg, 16.2 MJ/kg, and 19.1 MJ/kg in Dakar, Kampala, and Kumasi, respectively. A recent study by **Myers et al.???** found effective heats of combustion of 19.6 MJ/kg and 22.3 MJ/kg in samples from the India and the United States, respectively.  A meta-study by @roseCharacterizationFecesUrine2015b found the average and median for dry feces internationally are 17.2 MJ/kg and 19.1 MJ/kg. Wood pellets with an effective heat of combustion of 19.2 MJ/kg were identified as an appropriate substitute. 

The typical moisture content of fecal sludge treated by operating BRs is 35% moisture on a mass basis, i.e. 35% of the final feedstock mass entering the BR consists of water and 65% of dry fecal sludge. To simulate this moisture content, wood pellets were mixed with the appropriate mass of water in a large tumbler until the water was fully absorbed. The resulting mixture had the consistency of wet sawdust and could be smoothly fed into the BR.

## Thermal Power Balance Test

The thermal power balance testing was conducted on the BR with the ORC disconnected. During operation, the BR moves through several operational modes before converging on steady state. In real world operation, the ORC only generates power during the steady state. To best simulate this, the BR was brought to steady state and allowed to run for approximately three hours. 

Thermal energy enters the BR through the supplied feedstock which is pyrolyzed and then combusted, releasing most of its energy as 

$$Q_{in} = \Delta H_{c,fs}  \dot{m}_{fs}$$ 

During steady state, the energy entering the BR through the feedstock is equal to the energy that leaves the BR. This thermal power balance may be given as

$$Q_{in} = Q_{biochar} + Q_{OHX} + Q_{HHX} + Q_{loss}$$

where  $Q_{biochar}$ is the thermal power leaving through extracted biochar, $Q_{OHX}$ is the thermal power extracted by the oil working fluid heat exchanger, $Q_{HHX}$ is the thermal power extracted by the hydronic heat exchanger, and $Q_{loss}$ is the remaining thermal power lost to either radiant and convective heat transfer out of the exterior or jacket of the BR or through the hot gases escaping the stack.

The thermal energy remaining in the biochar is energy that was not extracted through complete combustion of the feedstock. The average thermal power lost to the biochar is determined from the biochar production rate, $\dot{m}_{biochar}$, and the effective heat of combustion of the biochar, $ \Delta H_{c,biochar}$, as

$$Q_{biochar} = \Delta H_{c,biochar}  \dot{m}_{biochar}$$

The total biochar produced during thermal power balance testing was massed, and divided by operating time to determine a biochar production rate. The effective heat of combustion of biochar from wood pellets can be estimated as 32.3 MJ/kg (Yang, 2017). This is similar to the average heat of combustion of biochar made from feces, 30.7 MJ/kg (Myers Fuel, 2019).

Thermal power extracted by the oil working fluid heat exchanger is given as

$$Q_{OHX} =  \dot{V}_{oil} \rho_{oil} c_{p,oil} (T_{oil,out} - T_{oil,in})$$

where $\dot{V}_{oil}$ is the volumetric flow rate of oil, $\rho_{oil}$ is the density of oil, $c_{p,oil}$ is the specific heat of the oil, and $T_{oil,out}$ and  $T_{oil,in}$ are the temperatures of the oil working fluid entering and leaving the oil heat exchanger. The oil used in the BR CHP oil working fluid heat exchanger was Duratherm FG, whose thermal are seen in Table \@ref(tab:tab-duratherm).


```{r tab-duratherm}

duratherm_oil %>% 
  rename(
    `Temperature [°C]` = temperature_c,
    `Density (kg/m3)` = density_kg_m_3_1,
    `Heat Capacity (kJ/kg-K)` = heat_capacity_k_j_kg_k_1
  ) %>% 
  knitr::kable(caption = "Thermal properties of Duratherm FG oil working fluid") 


```

The majority of this thermal power is transported to the ORC where it is used in electrical generation. Some thermal power is lost through so called “pipe heat losses”, where thermal power being transported in the fluid is lost through conduction to the pipe walls carrying the fluid. These pipe heat losses can be estimated as

$$Q_{PHL} = (T_{out} - T_{amb})/ (R_pipe + R_insul)$$

where $T_{amb})$ is the ambient air temperature, $R_pipe$ is the effective thermal resistance for the pipe leading from the oil working fluid heat exchanger to the ORC and  $R_insul$ is the effective thermal resistance of the insulation wrapping the pipe. The effective thermal resistance for a pipe or hollow cylinder is determined as

$$R = ln(r_o/r_i)/(2*\pi*L*k)$$

where $r_o$ is the outer radius, $r_i$ is the inner radius, $L$ is the length, and $k$ is the thermal conductivity of the material.

Thermal power is extracted by the hydronic heat exchanger is given as

$$Q_{HHX} = \dot{V}_{w} \rho_{w} c_{p,w} (T_{w,out} - T_{w,in})$$

where $\dot{V}_{w}$ is the volumetric flow rate of water, $\rho_{w}$ is the density of water, $c_{p,w}$ is the specific heat of the water, and $T_{w,out}$ and  $T_{w,in}$ are the temperatures of the water entering and leaving the hydronic heat exchanger. Most of the thermal power from the hydronic heat exchanger is delivered to the dryer but some thermal power is lost through pipe losses which can be calculated by equations **XX** and **YY**.

The remaining thermal power leaves the system through jacket and stack losses. The total of the jacket and stack losses are calculated using **equation 2** when the other elements of the thermal power balance are known. Jacket losses consist of thermal power convected or radiated away from the exterior of the BR. Stack losses include all thermal power in the hot exhaust gases leaving the system. Jacket temperatures were measured with an infrared thermometer at 12 points (4 on each section) every 30 minutes for the duration of steady state operation. The average temperatures was used to calculate total radiative and convective heat transfer from each portion of the BR. The exterior of the BR is not a uniform temperature, adding significant uncertainty to calculations of heat transfer from the surface. Further, precise pressure and flow measurements were not made, limiting the ability to explicitly calculate energy flow in the escaping hot gases. Instead, these losses were lumped together.

During steady state operation, the various temperatures mentioned above (water, and oil) were recorded using thermocouples and thermistors. Air temperatures of the hot gases within the BR were measured with thermocouples. The flow rates of water and oil were measured using ultrasonic flow meters. These sensor were integrated with the BR CHP controller with the results recorded in real time using the Biomass Controls kelvºn data plotter. Measurements were time averaged across steady state operation. Additional measurements, such as feedstock input rate, biochar production rate, and jacket temperatures were measured periodically throughout the test.

## Data Management

```{r, eval=FALSE}

pkgs <- grateful::scan_packages()

cites <- grateful::get_citations(pkgs, out.dir = here::here("manuscript/"))

```

Collected data is stored in a standard relational cloud database that provides a flexible and dynamic data management platform [@HIC2018:Remote_Sensing_Mobile_Applications]. Open source data science tools are used for data analysis to increase reproducibility, collaboration and communication [@lowndesOurPathBetter2017]. R Statistical Software and the RStudio Integrated Development Environment are used for data analysis [@base; @rstudioteamRStudioIntegratedDevelopment2018]. The following open source R packages have been used from accessing data to producing the final manuscript: bookdown, DBI, dbplyr, here, hms, lubridate, purrr, RMySQL, rstudioapi, snakecase, stringr, tidyverse [@DBI; @dbplyr; @here; @hms; @lubridate; @purrr; @RMySQL; @rstudioapi; @snakecase; @stringr; @tidyverse; @xieBookdownAuthoringBooks2016]. 

# Results and Analysis

## Thermal Power Balance

A thermal power balance in the Biogenic Refinery was constructed using the aforementioned measured system temperatures and flow rates. This thermal power balance can be seen in Figure \@ref(fig:fig-energy-balance). Specific details on the thermal power calculations for each section follows.

```{r fig-energy-balance, fig.cap="The energy flow of the Biogenic Refinery during steady state operation. Thermal power, in the form of feedstock, enters the system and is released by pyrolysis and combustion. Some thermal power is extracted through biochar, some through the oil working fluid heat exchanger, and some through the hydronic heat exchanger. The remaining energy is lost either through oil loop losses, water loop losses, radiant and convective heat transfer out of the jacket and through the hot gases escaping the stack"}

## Sankey Diagram that can be run as an individual chunk without dependency on other objects in this document.

power <- read_csv(file = here::here("data/final/chp_power_balance_final.csv"))

nodes_combined2 <- tibble(
    name = c(
    "Fuel Input", # 0
    "Biochar Output", # 1
    "Oil Heat Exchanger", # 2
    "Oil Loop Loss",  # 3
    "Hydronic Heat Exchanger", # 4
    "Water Loop Loss", # 5
    "Jacket Heat Loss", # 6
    "Stack Heat Loss", # 7
    "Organic Rankine Cycle", # 8
    "Drying Unit", # 9
    "Electrical Energy Generated", # 10
    "Electrical Energy Consumed", # 11
    "Net Power Produced" # 12
    ),
)


links_combined2 <- tibble(
  source = c(0, 0, 0, 0, 0, 2, 2, 4, 4, 8, 8, 10, 10),
  target = c(2, 4, 6, 7, 1, 8, 3, 9, 5, 9, 10, 11, 12),
  value = c(
      (filter(power, parameter == "Oil Heat Exchanger")$value + filter(power, parameter == "Oil Loop Loss")$value),
      (filter(power, parameter == "Hydronic Heat Exchanger")$value + filter(power, parameter == "Water Loop Loss")$value),
      filter(power, parameter == "Jacket Heat Loss")$value,
      filter(power, parameter == "Stack Heat Loss")$value,
      filter(power, parameter == "Biochar Output")$value,
      filter(power, parameter == "Oil Heat Exchanger")$value,
      filter(power, parameter == "Oil Loop Loss")$value,
      filter(power, parameter == "Hydronic Heat Exchanger")$value,
      filter(power, parameter == "Water Loop Loss")$value,
      filter(power, parameter == "Oil Heat Exchanger")$value - 2.2,
      2.2,
      1.1,
      2.2 - 1.1
      )
  )

## Add text to label

txt_combined <- links_combined2 %>% 
  group_by(target) %>% 
  summarise(
    total = sum(value)
  ) %>% 
  ungroup()

fuel_input2 <- tibble(
  target = 0,
  total = 104
)


txt_combined2 <- txt_combined %>% 
  bind_rows(fuel_input2) %>% 
  arrange(target)


nodes_combined3 <- nodes_combined2 %>% 
  #slice(-1) %>% 
  mutate(
    target = c(txt_combined2$target),
    name = c(paste0(name,' (', round(txt_combined2$total, 1), ' kW' ,')'))
    )
  
power_combined3 <- list(nodes = nodes_combined3, links = links_combined2)

sankey_combined3 <- sankeyNetwork(
  Links = power_combined3$links, 
  Nodes = power_combined3$nodes, 
  Source = "source",
  Target = "target",
  Value = "value", 
  NodeID = "name",
  units = "kWth", 
  fontSize = 18, 
  nodeWidth = 20, 
  fontFamily = "Arial",
  height = 900,
  width = 1500,
  sinksRight = FALSE)


sankey_combined3

```


### Feedstock input

```{r feedstock-input}

# Calculation of energy balance for Section 1 (containing pyrolysis and combustion). 

# heat input

## Total fuel input

m_fuel_kg_h <- fuel_rate_data %>% 
  summarise(m_fuel_kg_h = mean(mass_flow_kg_hr)) %>% 
  .$m_fuel_kg_h

## Moisture content of the fuel entering the refinery

moisture_content <- 35 ## %

## Dry fuel input
m_fuel_kg_s <- m_fuel_kg_h / 3600 * (1 - moisture_content / 100)

## energy density
calorific_value_fuel <- 19.2 ## MJ/kg 

## thermal power input of fuel
q_fuel <- m_fuel_kg_s * calorific_value_fuel * 1000 # kW

## evaporation
q_evap <- m_fuel_kg_h / 3600 * moisture_content / 100 * (2257 + 4.187 * (100 - 30))

## net thermal power input
q_in <- q_fuel - q_evap

# heat output

```

The surrogate feedstock described above were fed steadily into the BR. The fuel feed rate was measured to average `r round(m_fuel_kg_h * 0.65, digits = 1)` kg/hr on a dry basis. The calorific value of the feedstock was `r calorific_value_fuel` MJ/kg on a dry basis, resulting in a total heat input of `r round(q_fuel, digit = 1)` kWth. Of this, `r round(q_evap, digits = 1)` kWth was necessary to evaporate the water contained in the fuel prior to combustion. The remaining `r round(q_in, digits = 1)` kWth was released into the system.

### Biochar output

```{r heat-output}

## char output
## Char output was measured during operation
## Calorific value is taken from: (Yang, 2017)

m_char <- 0.00003 ## kg/s
calorific_value_char <- 33.8 ## MJ/kg
q_out <- m_char * calorific_value_char * 1000 ## kW


```

An average of `r m_char * 3600` kg/hr of biochar was produded during operation. The biochar has an estimated caloric value of `r calorific_value_char` MJ/kg. Therefore, `r round(q_out, digits = 1)` kWth of the original `r round(q_in, digits = 1)` kWth released into the system were not combusted and removed as biochar. 

### Oil working fluid heat exchanger 

```{r}

# summarise oil flow rate data

oil_flow_rate <- data_tidy %>%  
  filter(component == "oil_flow_rate") %>% 
  filter(status %in% c("Run-Dry", "Run-Wet", "RUN_OVERHEAT")) %>% 
  group_by(component, unit) %>% 
  summarise(
    mean_oil_flow_rate = mean(value),
    sd_oil_flow_rate = sd(value)
  ) 
# summarise oil in temperature  data

oil_in_temp <- data_tidy %>%  
  filter(component == "oil_in") %>% 
  filter(status %in% c("Run-Dry", "Run-Wet", "RUN_OVERHEAT")) %>% 
  group_by(component, unit) %>% 
  summarise(
    mean_oil_in_temp = mean(value),
    sd_oil_in_temp = sd(value)
  )

# summarise oil out temperature  data

oil_out_temp <- data_tidy %>%  
  filter(component == "oil_out") %>% 
  filter(status %in% c("Run-Dry", "Run-Wet", "RUN_OVERHEAT")) %>% 
  group_by(component, unit) %>% 
  summarise(
    mean_oil_out_temp = mean(value),
    sd_oil_out_temp = sd(value)
  ) 

```

The oil working fluid heat exchanger circulated Duratherm FG oil through the BR with an average flow rate of `r round(oil_flow_rate$mean_oil_flow_rate, digits = 1)` ± `r round(oil_flow_rate$sd_oil_flow_rate, digits = 1)` L/min, as measured by an ultrasonic flow meter. The average measured temperature of oil coming into the system was `r round(oil_in_temp$mean_oil_in_temp, digits = 1)` ± `r round(oil_in_temp$sd_oil_in_temp, digits = 1)` °C and the average measured temperature of oil entering the ORC was `r round(oil_out_temp$mean_oil_out_temp, digits = 1)` ± `r round(oil_out_temp$sd_oil_out_temp, digits = 1)` °C, both measured with thermistors connected to the BR controller. 

```{r}

## filter data for 165 °C

oil <- duratherm_oil %>% 
  filter(temperature_c == 165) %>% 
  select(density_kg_m_3_1, heat_capacity_k_j_kg_k_1)

## calculate the power that was delivered to the ORC

power_delivery_orc <- oil_flow_rate$mean_oil_flow_rate * (oil_out_temp$mean_oil_out_temp - oil_in_temp$mean_oil_in_temp) * (oil$density_kg_m_3_1  * oil$heat_capacity_k_j_kg_k_1 / 1000 / 60)

## Heat Loss pipe losses through oil pipe assembly

oil_pipe <- filter(pipe_assembly_data, component == "oil_pipe")

heat_loss_oil_pipe <- (oil_out_temp$mean_oil_out_temp - ambient_temp$mean_ambient_temp) /
  (oil_pipe$r_pipe_k_k_w + oil_pipe$r_insulation_k_k_w)


```

Using known thermal properties of the chosen Duratherm oil, it can be calculated that `r round(power_delivery_orc, digits = 1)` kWth of power was delivered from the system. The thermal energy in the oil loop was continuously transferred to a heat exchanger as part of the ORC system, where a portion of this thermal energy was subsequently converted into electricity. An additional `r round(heat_loss_oil_pipe, digits = 1)` kWth was extracted by the oil heat exchanger, but was dissipated as “loop losses”, or thermal energy losses through the oil pipe assembly into the ambient air.  

### Hydronic heat exchanger output

```{r}

## calculate water flow rate of hydronic heat exchanger during steady state operation

water_flow_rate <- data_tidy %>%  
  filter(component == "water_air_flow_rate") %>% 
  filter(status %in% c("Run-Dry", "Run-Wet", "RUN_OVERHEAT")) %>% 
  group_by(component, unit) %>% 
  summarise(
    mean_water_flow_rate = mean(value) * 4.54609,  ## conversion from gallons to liter
    sd_water_flow_rate = sd(value) * 4.54609 ## conversion from gallons to liter
  ) 


## calculate water temperature entering the hydronic heat exchanger

water_in_temp <- data_tidy %>%  
  filter(component == "heat_exchanger_water_in_temprature") %>% 
  filter(status %in% c("Run-Dry", "Run-Wet", "RUN_OVERHEAT")) %>% 
  group_by(component, unit) %>% 
  summarise(
    mean_water_in_temp = mean(value),
    sd_water_in_temp = sd(value)
  ) 

## calculate water temperature leaving the hydronic heat exchanger

water_out_temp <- data_tidy %>%  
  filter(component == "heat_exchanger_water_out_temprature") %>% 
  filter(status %in% c("Run-Dry", "Run-Wet", "RUN_OVERHEAT")) %>% 
  group_by(component, unit) %>% 
  summarise(
    mean_water_out_temp = mean(value),
    sd_water_out_temp = sd(value)
  ) 

```

The hydronic heat exchanger circulated water through the BR with a measured flow rate of `r round(water_flow_rate$mean_water_flow_rate, digits = 1) ` ± `r round(water_flow_rate$sd_water_flow_rate, digits = 1)` L/min. The average measured temperature of water coming into the system was `r round(water_in_temp$mean_water_in_temp, digits = 1)` ± `r round(water_in_temp$sd_water_in_temp, digits = 1)` °C and the average measured temperature of water exiting the system was `r round(water_out_temp$mean_water_out_temp, digits = 1) ` ± `r round(water_out_temp$sd_water_out_temp, digits = 1)` °C . 

```{r}


# get water properties for 85 °C

water_85 <- water_properties %>% 
  filter(temperature_c == 85) 
  

## calculate heat output of hydronic heat exchanger

heat_output_water <- 
  water_flow_rate$mean_water_flow_rate * 
  (water_out_temp$mean_water_out_temp - water_in_temp$mean_water_in_temp) * 
  water_85$density_kg_m_3 * 
  water_85$heat_capacity_k_j_kg_k / 1000 / 60

## calculate losses through water pipe

water_pipe <- filter(pipe_assembly_data, component == "water_pipe")

heat_loss_water_pipe <- (water_out_temp$mean_water_out_temp - ambient_temp$mean_ambient_temp) /
  (water_pipe$r_pipe_k_k_w + water_pipe$r_insulation_k_k_w)

## calculate heat loss of hydronic heat exchanger
## was previously calcualted with the following formula.
## heat_loss_water <- water_flow_rate$mean_water_flow_rate * 10 * water_85$density_kg_m_3 * water_85$heat_capacity_k_j_kg_k / 1000 / 60


```

Using known thermal properties of water, it can be calculated that `r round(heat_output_water, digits = 1)` kWth was delivered by the hydronic heat exchanger. This thermal energy was continuously dissipated through a radiator to simulate a connected, upstream fuel drying system. An additional `r round(heat_loss_water_pipe, digits = 1)` kWth was extracted by the hydronic heat exchanger, but was dissipated as “loop losses”, or thermal energy losses through the water pipe assembly into the ambient air. 

### Jacket and stack losses

```{r}

## External convective heat transfer coeffient (ambient)

heat_transfer_coeff <- 5

## Radiative Emissivity (Estimated)

radiative_emissivity <- 1

## analyse jacket loss data and calculate losses due to convection and radiation

jacket_heat_loss_sum <- jacket_heat_loss %>% 
  mutate(surface_area = width * length) %>% 
  mutate(
    q_loss_conv = heat_transfer_coeff * (temperature_c - ambient_temp$mean_ambient_temp) * surface_area / 1000,
    q_loss_radi = radiative_emissivity * 0.0000000567 * ((temperature_c + 273)^4 - (ambient_temp$mean_ambient_temp + 273)^4) / 1000
  ) %>% 
  group_by(section) %>% 
  summarise(
    sum_q_loss_conv = sum(q_loss_conv, na.rm = T),
    sum_q_loss_radi = sum(q_loss_radi, na.rm = T)
    ) %>% 
  mutate(q_loss_total = sum_q_loss_conv + sum_q_loss_radi)

## jacket heat loss total

jacket_heat_loss_total <- jacket_heat_loss_sum %>% 
  summarise(jacket_heat_loss_sum = sum(q_loss_total)) %>% 
  .$jacket_heat_loss_sum

## surface temperature average

surface_temp <- jacket_heat_loss %>% 
  group_by(section) %>% 
  summarise(mean_temperature = mean(temperature_c, na.rm = T))

```

```{r}

### calculate stack heat loss based on power balance

stack_heat_loss <- q_in - ## fuel input
  q_out -  ## biochar output
  power_delivery_orc -  ## power that was delivered to the ORC
  heat_loss_oil_pipe -  ## heat losses through oil pipe assembly
  heat_output_water -  ## heat output hydronic heat exchanger
  heat_loss_water_pipe -  ## calculate losses through water pipe
  jacket_heat_loss_total


```

Jacket and stack heat losses compose the remainder of the unaccounted for power leaving the system. A total of `r round(jacket_heat_loss_total, digits = 1)` kWth account for jacket heat losses and the remaining `r round(stack_heat_loss, digits = 1)` kWth are estimated to be stack heat losses. Section 1, as shown in Figure 1, had a measured average surface temperature of `r round(filter(surface_temp, section == 1)$mean_temperature, digits = 1)` °C. The result is an estimated jacket heat loss of `r round(filter(jacket_heat_loss_sum, section == 1)$q_loss_total, digits = 1)` kWth, of which `r round(filter(jacket_heat_loss_sum, section == 1)$sum_q_loss_conv, digits = 1)` were due to convection and `r round(filter(jacket_heat_loss_sum, section == 1)$sum_q_loss_radi, digits = 1)` due to radiation. Section 2 had an average surface temperature of `r round(filter(surface_temp, section == 2)$mean_temperature, digits = 1)` °C. The result is an estimated jacket heat loss of `r round(filter(jacket_heat_loss_sum, section == 2)$q_loss_total, digits = 1)` kWth, of which `r round(filter(jacket_heat_loss_sum, section == 2)$sum_q_loss_conv, digits = 1)` were due to convection and `r round(filter(jacket_heat_loss_sum, section == 2)$sum_q_loss_radi, digits = 1)` due to radiation. Section 3 had an average surface temperature of `r round(filter(surface_temp, section == 3)$mean_temperature, digits = 1)` °C. The result is an estimated jacket heat loss of `r round(filter(jacket_heat_loss_sum, section == 1)$q_loss_total, digits = 1)` kWth, of which `r round(filter(jacket_heat_loss_sum, section == 3)$sum_q_loss_conv, digits = 1)` were due to convection and `r round( filter(jacket_heat_loss_sum, section == 3)$sum_q_loss_radi, digits = 1)` due to radiation.


```{r}

# summarise pyrolysis temperature  data

pyrolysis_temp <- data_tidy %>% 
  filter(component == "fire_pot_temperature") %>% 
  filter(status %in% c("Run-Dry", "Run-Wet", "RUN_OVERHEAT")) %>% 
  group_by(component, unit) %>% 
  summarise(
    mean_pyrolysis_temp = mean(value),
    sd_pyrolysis_temp = sd(value)
  ) 

# summarise stack temperature  data

pre_hhx_temp <- data_tidy %>% 
  filter(component == "pre_hhx")  %>% 
  group_by(component, unit) %>% 
  summarise(
    mean_pre_hhx_temp = mean(value),
    sd_pre_hhx_temp = sd(value)
  ) 

# summarise stack temperature  data

stack_temp <- data_tidy %>% 
  filter(component == "stack_temperature") %>% 
  filter(status %in% c("Run-Dry", "Run-Wet", "RUN_OVERHEAT")) %>% 
  group_by(component, unit) %>% 
  summarise(
    mean_stack_temp = mean(value),
    sd_stack_temp = sd(value)
  ) 


```

The ambient air temperature was `r round(ambient_temp$mean_ambient_temp, digits =1 )` ± `r round(ambient_temp$sd_ambient_temp, digits = 1)` °C. The average temperature leaving section 1, following the pyrolysis pot, was `r round(pyrolysis_temp$mean_pyrolysis_temp, digits = 1)` ± `r round(pyrolysis_temp$sd_pyrolysis_temp, digits = 1)` °C. This temperature exceeds the temperature necessary for pathogen free outputs, exceeding the IWA 28:2018 pathogen threshold requirements. The average temperature leaving section 2, following the oil heat exchanger, `r round(pre_hhx_temp$mean_pre_hhx_temp, digits = 1)` ± `r round(pre_hhx_temp$sd_pre_hhx_temp, digits = 1)` °C. The average temperature leaving section 3, or the entire BR, was `r round(stack_temp$mean_stack_temp, digits = 1)` ± `r round(stack_temp$mean_stack_temp, digits = 1)` °C.

## 

```{r}

power_balance_final <- tibble(
  parameter = c(
    "Fuel Input", 
    "Biochar Output", 
    "Oil Heat Exchanger", 
    "Oil Loop Loss", 
    "Hydronic Heat Exchanger", 
    "Water Loop Loss",
    "Jacket Heat Loss",
    "Stack Heat Loss"
    ),
  value = c(
    q_in, ## fuel input
    q_out, ## biochar output
    power_delivery_orc, ## power that was delivered to the ORC
    heat_loss_oil_pipe, ## heat losses through oil pipe assembly
    heat_output_water, ## heat output hydronic heat exchanger
    heat_loss_water_pipe, ## losses through water pipe
    jacket_heat_loss_total, ## losses through jacket
    stack_heat_loss ## losses through stack
  ) 
)

## save output

write_csv(x = power_balance_final, path = here::here("data/final/chp_power_balance_final.csv"))
  
```

Table \@ref(tab:t-power-balance) shows the complete thermal power balance. Out of `r round(q_in, digits = 1)` kWth that went into the BR in the form of fuel, a sum of `r round(q_out + power_delivery_orc + heat_output_water, digits = 1)` kWth were captured as thermal power output, while a total of `r round(heat_loss_oil_pipe + heat_loss_water_pipe + jacket_heat_loss_total + stack_heat_loss, digits = 1)` kWth can be accounted as power losses.

```{r t-power-balance}

power_balance_final %>% 
  knitr::kable(digits = 1, caption = "Final power balance.") 

```

The thermal power balance is visualized as a Sankey Diagram in Figure \@ref(fig:sankey-power-balance).

```{r sankey-power-balance, include=TRUE, fig.cap="Final thermal power balance."}

nodes_chp2 <- tibble(
    name = c(
    "Fuel Input", # 0
    "Biochar Output", # 1
    "Oil Heat Exchanger", # 2
    "Oil Loop Loss",  # 3
    "Hydronic Heat Exchanger", # 4
    "Water Loop Loss", # 5
    "Jacket Heat Loss", # 6
    "Stack Heat Loss", # 7
    "Organic Rankine Cycle", # 8
    "Drying Unit" # 9
    ),
)


links_chp2 <- tibble(
  source = c(0, 0, 0, 0, 0, 2, 2, 4, 4),
  target = c(2, 4, 6, 7, 1, 8, 3, 9, 5),
  value = c(
      (filter(power, parameter == "Oil Heat Exchanger")$value + filter(power, parameter == "Oil Loop Loss")$value),
      (filter(power, parameter == "Hydronic Heat Exchanger")$value + filter(power, parameter == "Water Loop Loss")$value),
      filter(power, parameter == "Jacket Heat Loss")$value,
      filter(power, parameter == "Stack Heat Loss")$value,
      filter(power, parameter == "Biochar Output")$value,
      filter(power, parameter == "Oil Heat Exchanger")$value,
      filter(power, parameter == "Oil Loop Loss")$value,
      filter(power, parameter == "Hydronic Heat Exchanger")$value,
      filter(power, parameter == "Water Loop Loss")$value
      )
  )

## Add text to label

txt <- links_chp2 %>% 
  group_by(target) %>% 
  summarise(
    total = sum(value)
  ) %>% 
  ungroup() 

fuel_input <- tibble(
  target = 0,
  total = 104
)


txt2 <- txt %>% 
  bind_rows(fuel_input) %>% 
  arrange(target)


nodes_chp3 <- nodes_chp2 %>% 
  #slice(-1) %>% 
  mutate(
    target = c(txt2$target),
    name = c(paste0(name,' (', round(txt2$total, 1), ' kW' ,')'))
    )
  
power_chp3 <- list(nodes = nodes_chp3, links = links_chp2)

sankey3 <- sankeyNetwork(
  Links = power_chp3$links, 
  Nodes = power_chp3$nodes, 
  Source = "source",
  Target = "target",
  Value = "value", 
  NodeID = "name",
  units = "kWth", 
  fontSize = 19, 
  nodeWidth = 20, 
  fontFamily = "Arial",
  height = 900,
  width = 1200)


sankey3


```

## Electrical power balance

```{r}

# Electrical power generated by the Organic Rankine Cycle (ORC)
# Measurement was read directly from the digital display of the ORC

electrical_power_generated <- 2200

# Total System power draw on 2018-08-22 at 2:25 PM

power_draw <- 1000


```

During steady state operation of the Biogenic Refinery, the Organic Rankine Cycle generator was engaged and allowed to produce power. The ORC received approximately `r round(power_delivery_orc, digits = 1)` kWth of power from the oil working fluid heat exchanger. This was converted into approximately `r round(electrical_power_generated / 1000, digits = 1)` kWe of electrical power, an efficiency of `r round(electrical_power_generated / 1000 / power_delivery_orc * 100, digits = 1)` %, slightly exceeding the nominal 8% efficiency of the ORC. For the purposes of this test, the electrical power was released through a heating element and not used to power the system or charge a battery.

To measure parasitic load, the BR CHP system was connected to a WattNode Pulse energy and power meter. The meter measures energy using a current transformer clamped around the mains power cable for the BR CHP system connected to the wall-outlet. Although thermal energy is provided by the BR for drying incoming feedstock, the dryer itself is not considered a part of the BR CHP system. The average power draw from the BR CHP system, during steady state, was `r round(power_draw / 1000, digits = 1)` kWe. 

Figure **XYZ** shows the power consumed by the CHP system compared to the power generated by the ORC during steady-state operation. The BR CHP system thus produces `r round((electrical_power_generated - power_draw) / 1000, digits = 1)` kWe net power as the calculated difference between these terms. 

```{r}

nodes_orc <- tibble(
    name = c(
    "Organic Rankine Cycle (25.0 kW)", # 0
    "Electrical Energy Generated (2.2 kW)", # 1
    "Thermal Energy Lost (22.8 kW)", # 2
    "Eletrical Energy Consumed (1.0 kW)", # 3
    "Net Power Produced (1.2 kW)" # 4
    #"Example Losses A (7.8 kW)", # 5
    #"Example Losses B (15.0 kW)" # 6
    ),
)

links_orc <- tibble(
  source = c(0, 0, 1, 1), #, 2, 2),
  target = c(2, 1, 3, 4),# , 5, 6),
  value = 
    c(filter(power, parameter == "Oil Heat Exchanger")$value - 2.2,
      2.2,
      1.0,
      2.2 - 1.0
      #7.8,
      #15.0
    )
)

power_orc <- list(nodes = nodes_orc, links = links_orc)

sankey_orc <- sankeyNetwork(
  Links = power_orc$links, 
  Nodes = power_orc$nodes, 
  Source = "source",
  Target = "target",
  Value = "value", 
  NodeID = "name",
  units = "kWth", 
  fontSize = 18, 
  nodeWidth = 20, 
  fontFamily = "Arial",
  height = 400,
  width = 1100, sinksRight = FALSE)

sankey_orc


```

# Conclusions

The present study demonstrated that the the BR CHP system is capable of simultaneously meeting two key criteria of the emerging standard for community scale FSTU,  ISO/PC318. First, depathoginization was fast and consistent.The average treatment temperature of the BR ensures pathogen free outputs exceeding the CFR 40 Part 503 and emerging standard ISO/PC318 pathogen threshold requirements. Further, the energy contained in the fecal sludge can be effectively utilized through thermal oxidation, freeing it for use to meet the electrical needs of the FSTU. The BR CHP system produced an electrical energy surplus of 1.2 kW.

This demonstration does not fulfil all of the requirements of the emerging standard. In addition to this energy positivity, a true energy independent system needs suitable energy storage and management techniques. Further, system safety, reliability, and usability must all be demonstrated. However, despite these shortcomings, the present work shows promise for the near term solution to the global needs to community scale waste management.

# Data availability

This manuscript was written in R Markdown and is fully reproducible. All underlying data and software source code are licensed by CC0 1.0 License.

Data and source code are stored on GitHub and archived on Zenodo [@lars_schoebitz_2019_2562683]. Metadata for all data tables required to reproduce this article are described in https://github.com/larnsce/chp-article/blob/master/chp_article_data_tables_metadata.md.

# Grant information

Taylor to add.

# Acknowledgements

Taylor to add.

# References

**finalise at the end**



